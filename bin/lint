#!/usr/bin/env bash

set -euo pipefail

show_usage() {
    cat <<'USAGE'
Usage: bin/lint [OPTIONS]

Options:
  --rust          Run Rust linting only
  --cairo         Run Cairo formatting only
  --prettier      Run prettier formatting only
  --all           Run all linting (default)
  --check-only    Check formatting without applying changes
  --help          Show this help message
USAGE
}

CHECK_ONLY=false
SELECTED=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --rust)
            SELECTED+=("rust")
            ;;
        --cairo)
            SELECTED+=("cairo")
            ;;
        --prettier)
            SELECTED+=("prettier")
            ;;
        --all)
            ;;
        --check-only)
            CHECK_ONLY=true
            ;;
        --help)
            show_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
    shift
 done

if [ "$CHECK_ONLY" = true ]; then
    if [ ${#SELECTED[@]} -eq 0 ]; then
        exec bazelisk run //:lint
    fi

    TARGETS=()
    for item in "${SELECTED[@]}"; do
        case "$item" in
            rust)
                TARGETS+=("//:rust_lint")
                ;;
            cairo)
                TARGETS+=("//:cairo_lint")
                ;;
            prettier)
                TARGETS+=("//:prettier_lint")
                ;;
        esac
    done

    exec bazelisk run "${TARGETS[@]}"
fi

ARGS=()
for item in "${SELECTED[@]}"; do
    ARGS+=("--${item}")
 done

exec bazelisk run //:lint_fix -- "${ARGS[@]}"
